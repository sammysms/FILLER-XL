<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filler Ultra – Fixed Logic</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #ffffff; --accent: #3498db; --p1: #2ecc71; --p2: #e74c3c; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: var(--text); }
        #menu { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .menu-card { background: var(--card); padding: 3rem; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); text-align: center; }
        #gameArea { display: none; width: 100vw; height: 100vh; grid-template-rows: 60px 1fr 120px; grid-template-columns: 1fr; }
        .header { display: flex; justify-content: center; align-items: center; background: #222; font-weight: bold; font-size: 1.2rem; }
        .main-stage { display: flex; justify-content: center; align-items: center; position: relative; }
        .score-box { position: absolute; top: 20px; padding: 20px; border-radius: 15px; font-size: 2.5rem; font-weight: 900; background: rgba(0,0,0,0.4); min-width: 100px; text-align: center; }
        #p1Score { left: 40px; border-left: 8px solid var(--p1); }
        #p2Score { right: 40px; border-right: 8px solid var(--p2); }
        #grid { display: grid; gap: 2px; background: #333; border: 5px solid #333; border-radius: 8px; height: 70vh; width: 70vh; }
        .cell { width: 100%; height: 100%; transition: background 0.2s ease; }
        .owned-p1 { box-shadow: inset 0 0 0 3px rgba(255,255,255,0.5); }
        .owned-p2 { box-shadow: inset 0 0 0 3px rgba(0,0,0,0.5); }
        .palette { display: flex; justify-content: center; align-items: center; gap: 15px; background: #111; }
        .palette button { width: 65px; height: 65px; border: 4px solid transparent; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
        .palette button:hover:not(:disabled) { transform: scale(1.1); }
        .palette button:disabled { opacity: 0.1; filter: grayscale(1); cursor: not-allowed; }
        input, button.primary { padding: 12px 24px; font-size: 1rem; border-radius: 8px; border: none; margin: 10px; }
        input { background: #333; color: white; text-align: center; width: 120px; }
        button.primary { background: var(--accent); color: white; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="menu">
    <div class="menu-card">
        <h1>FILLER</h1>
        <button class="primary" onclick="createGame()">CREATE NEW GAME</button>
        <p style="color: #666;">— OR —</p>
        <input id="codeInput" placeholder="CODE" maxlength="5">
        <button class="primary" onclick="joinGame()">JOIN GAME</button>
    </div>
</div>

<div id="gameArea">
    <div class="header" id="gameHeader">GAME CODE: ---</div>
    <div class="main-stage">
        <div id="p1Score" class="score-box">0</div>
        <div id="grid"></div>
        <div id="p2Score" class="score-box">0</div>
    </div>
    <div class="palette" id="palette"></div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyB4114xQshijIMW2yBioIuZdgN6Vpo3k3U",
    authDomain: "filler-xl.firebaseapp.com",
    projectId: "filler-xl",
    storageBucket: "filler-xl.firebasestorage.app",
    messagingSenderId: "613837258322",
    appId: "1:613837258322:web:21f4a1050a22cafe28698b",
    measurementId: "G-TYKQDC906H"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const SIZE = 20;
const COLORS = ["#e74c3c", "#3498db", "#2ecc71", "#f1c40f", "#9b59b6", "#e67e22"];
let gameId, player, gameRef, state;

function createValidGrid() {
    const grid = [];
    for (let r = 0; r < SIZE; r++) {
        grid[r] = [];
        for (let c = 0; c < SIZE; c++) {
            let options = [0,1,2,3,4,5];
            if (r > 0) options = options.filter(i => i !== grid[r-1][c]);
            if (c > 0) options = options.filter(i => i !== grid[r][c-1]);
            grid[r][c] = options[Math.floor(Math.random() * options.length)];
        }
    }
    return grid;
}

function createGame() {
    gameId = Math.random().toString(36).substr(2, 5).toUpperCase();
    player = "p1";
    const grid = createValidGrid();
    const gameState = {
        grid,
        owners: { "0,0": "p1", [`${SIZE-1},${SIZE-1}`]: "p2" },
        colors: { p1: grid[0][0], p2: grid[SIZE-1][SIZE-1] },
        turn: "p1",
        active: true
    };
    db.ref("games/" + gameId).set(gameState).then(() => connectToGame());
}

function joinGame() {
    gameId = document.getElementById("codeInput").value.trim().toUpperCase();
    if(!gameId) return alert("Enter code!");
    player = "p2";
    // Check if game exists before connecting
    db.ref("games/" + gameId).once("value", snap => {
        if(snap.exists()) {
            connectToGame();
        } else {
            alert("Game Code not found!");
        }
    });
}

function connectToGame() {
    gameRef = db.ref("games/" + gameId);
    gameRef.on("value", snap => {
        state = snap.val();
        if (!state) return;
        document.getElementById("menu").style.display = "none";
        document.getElementById("gameArea").style.display = "grid";
        render();
    });
}

function render() {
    const p1Count = Object.values(state.owners).filter(v => v === 'p1').length;
    const p2Count = Object.values(state.owners).filter(v => v === 'p2').length;
    document.getElementById("p1Score").textContent = p1Count;
    document.getElementById("p2Score").textContent = p2Count;
    document.getElementById("gameHeader").textContent = `CODE: ${gameId} | ${state.turn === player ? "YOUR TURN" : "WAITING..."}`;

    const gridDiv = document.getElementById("grid");
    gridDiv.style.gridTemplateColumns = `repeat(${SIZE}, 1fr)`;
    gridDiv.innerHTML = "";

    for (let r = 0; r < SIZE; r++) {
        for (let c = 0; c < SIZE; c++) {
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.style.background = COLORS[state.grid[r][c]];
            const owner = state.owners[`${r},${c}`];
            if (owner) cell.classList.add(owner === 'p1' ? 'owned-p1' : 'owned-p2');
            gridDiv.appendChild(cell);
        }
    }

    const pal = document.getElementById("palette");
    pal.innerHTML = "";
    COLORS.forEach((color, i) => {
        const btn = document.createElement("button");
        btn.style.background = color;
        // FIXED RULE: You can pick ANY color except yours or your opponent's.
        btn.disabled = (state.turn !== player || i === state.colors.p1 || i === state.colors.p2);
        btn.onclick = () => makeMove(i);
        pal.appendChild(btn);
    });
}

function makeMove(colorIndex) {
    const newState = JSON.parse(JSON.stringify(state));
    newState.colors[player] = colorIndex;
    const queue = [];
    const visited = new Set();

    for (const key in newState.owners) {
        if (newState.owners[key] === player) queue.push(key.split(",").map(Number));
    }

    while (queue.length) {
        const [r, c] = queue.shift();
        const key = `${r},${c}`;
        if (visited.has(key)) continue;
        visited.add(key);
        newState.grid[r][c] = colorIndex;
        newState.owners[key] = player;
        [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dr, dc]) => {
            const nr = r + dr, nc = c + dc;
            if (nr < 0 || nc < 0 || nr >= SIZE || nc >= SIZE) return;
            // Capture logic: if neighbor is the color we just picked, it's ours now.
            if (newState.grid[nr][nc] === colorIndex || newState.owners[`${nr},${nc}`] === player) {
                queue.push([nr, nc]);
            }
        });
    }
    newState.turn = player === "p1" ? "p2" : "p1";
    gameRef.set(newState);
}
</script>
</body>
</html>